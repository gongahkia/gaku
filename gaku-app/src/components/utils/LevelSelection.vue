<template>
    <div class="level-selection-container">
      <h2>Choose Explanation Level</h2>
      <p class="description">
        Select how detailed you want your document summary to be.
      </p>
      
      <div class="level-cards">
        <LevelCard 
          v-for="level in levels" 
          :key="level.id"
          :level="level"
          :isSelected="selectedLevel === level.id"
          @select="selectLevel(level.id)"
        />
      </div>
      
      <DocumentPreview 
        :fileName="fileName" 
        :textPreview="textPreview" 
      />
      
      <div class="action-buttons">
        <button class="back-button" @click="goBack">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Back
        </button>
        <button 
          class="generate-button" 
          :disabled="!selectedLevel || isGenerating" 
          @click="generateSummary"
        >
          <span v-if="isGenerating">
            <LoadingSpinner />
            Generating...
          </span>
          <span v-else>Generate Summary</span>
        </button>
      </div>
    </div>
  </template>
  
  <script setup lang="ts">
  import { ref, computed } from 'vue';
  import { useRouter } from 'vue-router';
  import { useDocumentStore } from '../../stores/documentStore';
  import { useSummaryStore } from '../../stores/summaryStore';
  import { GoogleGenerativeAI } from "@google/generative-ai";
  import LoadingSpinner from '../UI/LoadingSpinner.vue';
  import LevelCard from './LevelCard.vue';
  import DocumentPreview from './DocumentPreview.vue';
  
  const router = useRouter();
  const documentStore = useDocumentStore
  const summaryStore = useSummaryStore();

const selectedLevel = ref<number | null>(null);
const isGenerating = ref(false);

const fileName = computed(() => documentStore.fileName || 'Unnamed Document');
const textPreview = computed(() => {
  const text = documentStore.documentText;
  if (!text) return 'No text extracted';
  return text.length > 100 ? text.substring(0, 100) + '...' : text;
});

const levels = [
  { id: 1, name: 'Child (5-8 years)', emoji: '👶', description: 'Simple explanations using basic vocabulary and familiar concepts.' },
  { id: 2, name: 'Teen (13-16 years)', emoji: '🧑‍🎓', description: 'More detailed explanations with some technical terms introduced.' },
  { id: 3, name: 'College Student (18-24 years)', emoji: '🎓', description: 'In-depth explanations with field-specific terminology and concepts.' },
  { id: 4, name: 'Graduate Student (25+ years)', emoji: '🔬', description: 'Advanced explanations assuming strong background knowledge.' },
  { id: 5, name: 'Expert (30+ years)', emoji: '🧠', description: 'Highly technical and detailed explanations for subject matter experts.' },
  { id:6, name: 'Teacher', emoji: '👨‍🏫', description: 'Detailed explanations for teachers to help students understand complex concepts.' },
  { id:7, name: 'Flash Cards', emoji: '💡', description: 'Bite-sized summaries optimized for quick review and memorization.' },
  { id:8, name: 'Knowledge Graph', emoji: '🌐', description: 'Visual representation of key concepts and their relationships.' },
  { id:9, name: 'Short and Sweet', emoji: '🍬', description: 'One paragraph summaries of core ideas.' },
];

const selectLevel = (levelId: number) => {
  selectedLevel.value = levelId;
};

const goBack = () => {
  router.push('/');
};

const generateSummary = async () => {
  if (!selectedLevel.value) return;
  isGenerating.value = true;
  try {
    const level = levels.find(l => l.id === selectedLevel.value);
    if (!level) throw new Error('Invalid level selected');
    const genAI = new GoogleGenerativeAI(import.meta.env.VITE_GEMINI_API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
    const prompt = getLevelSpecificPrompt(level.id, documentStore.documentText); // tailored prompts for each usecase
    console.log(prompt);
    const result = await model.generateContent(prompt);
    console.log(result);
    const summary = result.response.text();
    summaryStore.setSummary(summary);
    summaryStore.setLevel(level);
    router.push('/summary');
  } catch (error) {
    console.error('Error generating summary:', error);
    alert('An error occurred while generating the summary. Please try again.');
  } finally {
    isGenerating.value = false;
  }
};

const getLevelSpecificPrompt = (levelId: number, documentText: string): string => {
  // FUA to remove this below predefined document text once the OCR is properly working and documentext is fed properly
  documentText = `
  Singapore Copyright Law
  Copyright in Singapore is governed by the Copyright Act (Cap 63, 2006 Rev Ed), supplemented by various subsidiary legislation including:
    Copyright (International Organisations) Regulations
    Copyright (International Protection) Regulations
    Copyright (Records Royalty System) Regulations
    Copyright (Border Enforcement Measures) Regulations
    Copyright (Network Service Provider) Regulations
  `
  const prompts = {
    1: `You are explaining to a young child (5-8 years old). 
       Use very simple vocabulary, short sentences, and familiar examples.
       Avoid abstract concepts.
       Use concrete examples that relate to a child's everyday experiences.
       Explain as if you're telling a story to maintain engagement.
       Limit your explanation to 3-5 simple paragraphs.
       Here's the text to summarize: ${documentText}`,
    
    2: `You are explaining to a teenager (13-16 years old).
       Use clear language with some introductory technical terms (but explain them).
       Include relatable examples that connect to teen interests and experiences.
       You can introduce some complexity, but maintain clarity.
       Include 1-2 thought-provoking questions to stimulate curiosity.
       Structure your explanation with clear headings if needed.
       Here's the text to summarize: ${documentText}`,
    
    3: `You are explaining to a college student (18-24 years).
       Use proper academic language and field-specific terminology.
       Provide in-depth explanations of concepts and their relationships.
       Include relevant theoretical frameworks where appropriate.
       Reference key principles and methodologies in the field.
       Structure your explanation with clear sections and logical flow.
       Here's the text to summarize: ${documentText}`,
    
    4: `You are explaining to a graduate student (25+ years).
       Use advanced terminology and concepts without simplification.
       Assume strong background knowledge in the subject area.
       Discuss methodological considerations and limitations.
       Address nuances, exceptions, and competing perspectives.
       Include references to advanced concepts and current research directions.
       Here's the text to summarize: ${documentText}`,
    
    5: `You are explaining to a subject matter expert.
       Use the most technical and precise language appropriate for the field.
       Focus on cutting-edge aspects and nuanced details.
       Discuss theoretical implications and methodological considerations.
       Address gaps, limitations, and potential future directions.
       Reference specialized frameworks and advanced concepts.
       Here's the text to summarize: ${documentText}`,
    
    6: `You are creating an explanation for a teacher to use with students.
       Structure the content in a teaching-friendly format.
       Include 3-5 key learning objectives at the beginning.
       Provide explanations at multiple levels of complexity.
       Include suggested analogies, examples, and visual descriptions.
       Add 2-3 discussion questions and potential student misconceptions to address.
       End with a simple assessment activity suggestion.
       Here's the text to summarize: ${documentText}`,
    
    7: `Create a set of 10-15 flash cards based on this content.
       Format each flash card as "Question: [question]" followed by "Answer: [answer]"
       Questions should be concise and focus on key concepts.
       Answers should be brief (1-3 sentences) and precise.
       Include a mix of definition, application, and conceptual questions.
       Ensure cards progress from fundamental to more advanced concepts.
       Here's the text to use: ${documentText}`,
    
    8: `Create a knowledge graph representation of the key concepts in this text.
       Format your response as a list of:
       1. Core concepts (5-10 main ideas)
       2. Relationships between concepts (how they connect)
       3. Hierarchical structure (which concepts contain others)
       4. Key attributes for each concept
       5. A text description of how to visualize this as a network diagram
       Here's the text to analyze: ${documentText}`,
    
    9: `Create an extremely concise "Short and Sweet" summary.
       Limit your response to ONE paragraph (5-7 sentences maximum).
       Focus only on the most essential core ideas.
       Use clear, direct language with no unnecessary words.
       Ensure the summary could be understood by a general audience.
       Here's the text to summarize: ${documentText}`
  };
  
  return prompts[levelId as keyof typeof prompts] || 
    `Summarize the following text for a general audience: ${documentText}`;
};
</script>

<style lang="scss" scoped>
.level-selection-container {
  max-width: 800px;
  margin: 0 auto;
  
  h2 {
    font-size: 1.8rem;
    margin-bottom: 1rem;
  }
  
  .description {
    color: #6b7280;
    margin-bottom: 2rem;
  }
  
  .level-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }
  
  .action-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 2rem;
    
    .back-button {
      background-color: transparent;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      
      &:hover {
        background-color: rgba(79, 70, 229, 0.05);
      }
    }
    
    .generate-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
  }
}
</style>